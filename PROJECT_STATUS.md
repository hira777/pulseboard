# Project Status

- 更新履歴:
  - 2025-10-03 フェーズ 3 を「予約作成フロー (UC-1)」へ変更
  - 2025-09-14 フェーズ 2 完了
  - 2025-09-12 フェーズ 1 完了
  - 2025-09-09 初稿

## ✅ 完了（Confirmed Done）

- RLS/制約の基本検証（admin/member 切替で許可/拒否を確認）
- スキーマ初期案の確立（`schema.md`）

### フェーズ 1: **RLS/制約の実証**

- Supabase ローカル環境の起動・初期化（`runbook-rls.md` の通り）
- 想定どおりの許可/拒否、`canceled` 重複対象外の挿入可否など

`runbook-rls.md`で記載されていたテスト方法は手動の想定だったが、Jest で自動テストができるようにテスト環境を整備した。

実行するテストは以下のファイル。

- `tests/db/rls.test.ts`

それに伴い`runbook-rls.md`は不要になったが、アーカイブとして残しておきたいので`docs/archives/`に移動した。

### フェーズ 2: **/t/:slug ルーティング基盤**

- ルーティング導入: `/t/[slug]/layout.tsx`（URL 値は slug。所属チェック → 未所属は `notFound()`=404）
- ダッシュボード骨組み: `/t/[slug]/page.tsx`
- テナント選択: `/t/select/page.tsx`（Server Action で `tenant_id` Cookie 設定 → リダイレクトは `/t/:slug`）
- 404 UI 統一: `app/not-found.tsx` + `app/__404`（middleware からの rewrite 用）
- middleware: `/` と `/dashboard` を Cookie 既定テナントの slug へ誘導、`/t/*` 要ログイン、`/admin` 未権限は `__404` へ rewrite
- 権限ヘルパー: `src/features/auth/tenant.ts`（ページ=404、API/Action=403 の分離）
- E2E: `e2e/tenant-routing.spec.ts` を追加（直リンク/404/既定テナント誘導の検証）

## 🚧 進行中（In Progress）

- フェーズ 3: **予約作成フロー (UC-1)** — 予約作成 API の仕様確定からテスト整備まで
  - [x] `docs/requirements.md` と `docs/db/schema.md` を読み直し、UC-1 の前提を整理する。
    - [x] 予約・予約可能枠・在庫に関わる章をピックアップして確認する。
    - [x] 営業時間、休業日、必須項目、在庫ルールを箇条書きでメモする。
    - [x] 不明点や追加確認が必要な項目を別途リスト化する。
  - [ ] `docs/roadmap.md` のフェーズ 3 を細分化し、作業順序を決める。
    - [ ] フェーズ 3 節を読み、成果物と工程（API 仕様 → バリデーション/競合チェック → テスト）を整理する。
    - [ ] 各工程で必要な実装範囲（入力検証・例外日処理・DB 書き込みなど）を書き出す。
    - [ ] 順序案を短い説明付きでまとめ、共有準備を整える。
  - [ ] `POST /t/{tenantId}/reservations` の API 仕様を `docs/design/api-overview.md` にドラフトする。
    - [ ] 既存内容を確認し、追記位置を決める。
    - [ ] 入力パラメータと型・必須/任意を整理して記載する。
    - [ ] 成功・候補なし・409 のレスポンス例とエラーコード一覧を書く。
    - [ ] バリデーションルールを箇条書きにし、レビュー依頼コメントを用意する。
  - [ ] 仕様に合わせて `PROJECT_STATUS.md` の内容を更新する。
    - [ ] 進行中欄をドラフトした順序と担当ステップで書き換える。
    - [ ] 「次にやること」を最新タスク（API 仕様レビュー、ロジック実装、テスト設計）に整える。
    - [ ] 更新後の記述を読み、ステータスが明確かチェックする。
  - [ ] 既存コード・ドキュメントの影響範囲を洗い出す。
    - [ ] `src/features/availability` 配下を確認し、不要になる処理や再利用関数をメモする。
    - [ ] 関連ドキュメントを検索し、更新が必要なファイルをリスト化する。
    - [ ] 不要になりそうなエントリ（例: `listAvailability` 関連）の扱い方針をまとめる。
  - [ ] 予約作成ロジックの実装タスクを準備する。
    - [ ] 入力バリデーション用の型定義とチェック関数を設計する。
    - [ ] 部屋 EXCLUDE・機材在庫・スタッフ重複の競合判定ロジックを設計する。
    - [ ] 例外日チェックのクエリと判定処理の構成を決める。
    - [ ] 予約保存と関連レコード作成、エラーハンドリングの流れを整理する。
  - [ ] テスト追加タスクを設計する。
    - [ ] 正常系（予約成功）のテストケースを新規ファイル案とともにまとめる。
    - [ ] 候補なし・409 競合のテストケース案を記述する。
    - [ ] 既存テストへの影響有無を確認し、必要な更新を洗い出す。
    - [ ] `pnpm test --filter reservations` など実行コマンドと期待結果をメモする。

## 🐞 Known Issues / リスク

- ブラウザ間（特に Safari）での Cookie/セッション同期の不安定さ
- RLS 例外ケース（予約のリスケと在庫の同時更新など）未テスト
- WebSocket/リアルタイム反映は v1 では最小（トースト通知程度）

## 📊 KPI / 完了基準（S1）

- RLS/制約：想定どおりの許可/拒否が再現
- 予約 CRUD：二重送信なし。版ずれ時ロールバック＋差分提示
- 予約可能枠 API：期待件数・順序・理由コード一致、ページング正常（フェーズ 4 で再開）
- UI：ダッシュボード最小、予約作成/編集/取消の一連操作が完了可能

## 📚 参照

- 要件: `docs/requirements.md`
- スキーマ: `docs/db/schema.md`
- RLS 実証: `docs/archives/runbook-rls.md`
- ロードマップ: `docs/roadmap.md`
- API 概要: `docs/design/api-overview.md`
