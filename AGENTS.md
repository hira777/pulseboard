## 0. ゴールと対象

- ゴール: マルチテナントの「撮影スタジオ＋機材レンタル」向け 予約管理ダッシュボード（Pulseboard）を安全・高速に提供する。
- 対象: Web（最新 Chrome/Firefox/Safari/Edge）、Node.js 20+、Next.js 15、TypeScript。

## 1. 作業スタイル

- フレームワーク: **Next.js 15 App Router** + React 18 + TypeScript。
- UI/スタイル: Tailwind（既存設計に準ずる）。
- 状態: ページ/機能単位で局所的に（過剰なグローバル状態は避ける）。
- 変更原則: **最小差分**。破壊的変更・依存追加・データモデル変更は「提案 → 承認」。
- ドメイン準拠: 予約・機材・可用枠は `requirements.md` の業務ルールを優先。

## 2. セキュリティ / 権限

- 認証: Supabase JWT（admin / member）。**テナント境界**は URL ルート `/t/:tenantId`。
- 表示権限: ページは **未権限=404**（秘匿）、API/操作は **未権限=403**（拒否）。
- RLS: Postgres Row Level Security と制約ベースで保護。`runbook-rls.md` の検証手順を尊重。
- 秘密情報: `*KEY*/*TOKEN*/*SECRET*` を出力・ログ・送信しない。

## 3. サンドボックス / 実行

- 既定: `sandbox_mode = "read-only"`, `approval_policy = "untrusted"` を想定。
- 外部ネットワークや依存追加（例: `npm/pnpm install`）は、必要時のみ承認取得。
- 危険操作（例: `rm -rf`, `chmod -R`, `git push --force`）は提案のみ。自動実行しない。

## 4. DB / スキーマ

- 参照: `schema.md`（テーブル定義・主外キー・RLS 前提の関係性）。
- 予約はライフサイクル（作成 → 更新 → キャンセル/リスケ）と整合性を重視。
- 競合判定/可用枠は **v1 ロジック**（`requirements.md` の「競合/可用枠ロジック（v1）」）に準拠。

## 5. 主要ユースケース（抜粋）

- 予約の作成/変更/キャンセル/リスケ/担当者割当。
- 可用枠の検索（期間・サービス・部屋・機材条件）。
- ブラックアウト（例外日）・営業時間・機材在庫と整合した空き判定。
- 管理（部屋/サービス/機材 SKU/個体、スタッフ、料金・稼働設定）。

## 6. ルーティング / UI

- ルート: `/t/:tenantId/...`（**直リンク可能**）。未権限は 404、API は 403。
- ダッシュボード: KPI・最近更新・ショートカット（S1 最小）。
- 予約 UI: カレンダー/テーブル、作成編集モーダル、競合理由の提示。
- 管理 UI: 部屋/サービス/機材（SKU・個体）・スタッフの CRUD（admin のみ編集、member は参照）。

## 7. 可用枠 / 競合（v1）

- 可用枠 API: `listAvailability`（入出力仕様、ページング ≤50、理由コード）。
- 競合基準: 時間帯・部屋/機材在庫・ブラックアウト・営業時間を反映。
- 最終判定はサーバ側（Server Actions/API）で一貫性を担保。

## 8. 非機能 / 監査 / テレメトリ

- 監査: 操作ログ・内部メモの保存。RLS/制約違反の検知。
- エラー規約: ユーザ向けメッセージと技術情報を分離。再現手順/相関 ID 付与。
- テレメトリ: 重大イベント（予約更新、在庫異常）に限定。

## 9. 出力フォーマット（AI 応答期待）

- **diff/patch** + 要約 + 影響範囲 + 検証手順（再現コマンド）を含める。
- 複数ファイル変更はファイルごとに目的と確認方法を列挙。
- 参照根拠（`requirements.md`/`schema.md`/`runbook-rls.md`）の章・見出しを併記。

## 10. テスト / 受け入れ（S1）

- E2E: Playwright（主要フロー：予約 CRUD、可用枠検索、ロール別アクセス）。
- 受け入れ基準は `requirements.md` の「受け入れ基準（S1）」および `roadmap.md` 各フェーズの基準に合わせる。

## 11. 参考

- 要件: `docs/requirements.md`
- スキーマ: `docs/schema.md`
- RLS 実証: `docs/runbook-rls.md`
- ロードマップ: `docs/roadmap.md`
- Project Status: `AGENTS.md`
