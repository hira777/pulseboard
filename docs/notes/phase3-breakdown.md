# フェーズ 3 予約作成フロー (UC-1) 作業順序案

## 概要

フェーズ 3 では予約作成 API を中心に、仕様整理 → バリデーションと競合判定 → テスト計画の順で進めます。以下の手順は各ステップで作成する成果物と参照ドキュメントを明示し、チーム内共有を容易にすることを目的としています。

## 手順リスト

- [ ] API 仕様策定 — `POST /t/{tenantId}/reservations` の入出力とエラー規約を整理し、ドラフトを `docs/api/reservations.md` に反映する。
  - インプット: `docs/requirements.md`, `docs/db/schema.md`, `docs/notes/uc1-preconditions.md`。
  - 成果物: 主要パラメータ一覧、レスポンス例（成功／候補なし／409）、エラーコード定義、Idempotency 方針メモ。
  - 留意点: Server Action で実装する想定か REST 化するかを決め、認可と RLS の整合を確認する。
- [ ] バリデーション・競合チェック整理 — 入力検証とリソース競合ロジックを洗い出し、実装タスク化する。
  - インプット: スキーマ仕様、`calendar_exceptions` / `reservation_equipment_items` のドキュメント。
  - 成果物: チェックリスト（必須項目、時間帯検証、例外日判定、部屋 EXCLUDE、機材個体割当、スタッフ重複）、処理順序のメモ。
  - 留意点: タイムゾーン変換ポイント（店舗 TZ ↔ UTC）とバッファ適用範囲を明記し、例外処理時のエラーハンドリングを仕様と揃える。
- [ ] テスト計画 — 正常系と例外系を網羅するテスト戦略をまとめ、実装担当に引き渡す。
  - インプット: 上記仕様ドラフト、既存テスト構成（`tests/features/`）。
  - 成果物: 単体テストケース一覧（正常／候補なし／409 競合／境界値）、必要なモックやフィクスチャのメモ、将来的な E2E 追加の検討メモ。
  - 留意点: 予約可能枠 API との依存やデータ整合性を確認し、テストデータ生成手順を記録する。

## 次のアクション例

- [ ] 上記チェックリストを PROJECT_STATUS.md の該当タスクと紐づけ、進捗更新の基準にする。
- [ ] API 仕様ドラフトレビュー後、バリデーション・競合チェックの具体的な実装タスクを Issue 化する。
- [ ] テスト計画をもとに `tests/features/reservations/` 配下のテストファイル構成案を作成する。
