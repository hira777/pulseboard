# 実装ロードマップ / TODO（v1 → 本番）

最短で S1 達成から本番運用までの工程を段階化。各フェーズは受け入れ基準を満たしたら次へ進む。並行可能な項目は明記。

更新履歴: 2025-10-03 可用枠フェーズを予約作成フェーズへ改定

---

## 全体方針

- 小さく縦切りで届ける（DB/RLS 実証 → ルーティング → 予約作成 CRUD → 可用枠検索 → UI S1）。
- 失敗しづらい設計: Idempotency・If-Match・標準エラー形でフロントの一貫性を担保。
- マルチテナントは常に `/t/:slug` を前提。未認可は 404 秘匿、操作 API は 403。

---

## フェーズ 0 準備

- 開発環境整備: Supabase CLI/Playwright、`.env` 設定。
- マイグレーション実行: `0001_profiles.sql` → `0002_core.sql`。
- テストユーザー: `admin`/`member` 作成、`tenant_users` 紐付け。
- ダミーデータ: `tenants/rooms/services/equipments` 最小セット。

受け入れ基準

- ローカルで DB が初期化済み、最低限の参照が可能。

---

## フェーズ 1 RLS/制約の実証

- RLS 確認: admin/member JWT 切替で参照/書込の可否を検証。
- EXCLUDE 制約: 同一部屋の重複予約が弾かれることを確認。
- 監査/メッセージ: `audit_logs/messages` の選択/挿入ポリシー確認。

受け入れ基準

- 想定どおりの許可/拒否が再現。`canceled` は重複対象外で挿入可。

---

## フェーズ 2 テナントルーティング基盤

- ルート導入: `/t/:slug` 配下に `layout.tsx` と主要ページ骨組み。
- 既定テナント: Cookie→`/t/:slug` リダイレクトを middleware に追加。
- 認可方針: 未認可は 404 秘匿、操作 API は 403 を維持。

受け入れ基準

- 直リンク/ブックマーク可能。未認可アクセスは 404。

---

## フェーズ 3 予約作成フロー (UC-1)

- IF 確定: 予約作成 API (`POST /t/:tenantId/reservations`) の入出力・エラー規約を定義。
- バリデーション: サービス・部屋・機材・スタッフ・日時に対する入力検証。
- 競合チェック: 部屋 EXCLUDE 制約、機材在庫（SKU/個体）、スタッフ重複を統合的に判定。
- 例外チェック: `calendar_exceptions` を考慮して休業・メンテ時間帯を除外。
- 永続化: `confirmed` 状態で予約を保存し、関連する機材個体割当を作成。
- テスト: 正常系（予約成功）／例外系（候補なし・409 競合）を網羅する単体テスト。

受け入れ基準

- UC-1（予約を作成する）の正常系・例外系がすべて自動テストで再現できる。既存の RLS 制約に違反しない。

---

## フェーズ 4 可用枠 API v1（再計画）

- IF 再定義: `listAvailability` の入出力・ページング・理由コードを UC-1 実装の知見を踏まえて再設計。
- ロジック: 営業時間 → 例外 → 部屋重複 → 機材在庫の順で候補生成、スタッフ条件をオプション化。
- テスト: 境界・バッファ・不可理由を網羅する単体テスト。

受け入れ基準

- 期待件数/順序/理由コードが一致。`n≤50` ページング正常。予約作成フローと整合する。

---

## フェーズ 5 予約 CRUD ＋競合最終判定

- API/Server Action: `create/update/cancel` 実装、`If-Match` で 409 時に最新スナップ返却。
- Idempotency: 変更系で `Idempotency-Key` を受理し重複作成を防止。

受け入れ基準

- 二重送信なし。版ずれ時はロールバック＋差分提示。

---

## フェーズ 6 UI S1（運用最小）

- ダッシュボード: KPI/最近更新/ショートカット（最小）。
- カレンダー（週/日）: 部屋列、作成/リスケ D&D→ACK/rollback。
- 予約一覧: サーバフィルタ/ソート＋仮想スクロール。
- 予約詳細ドロワー: 状態遷移・内部メモ・監査閲覧。

受け入れ基準

- S1 の受け入れ項目を満たし、基本運用が一連で完結。

---

## フェーズ 7 管理画面 S1

- 部屋/サービス/機材（SKU）CRUD、個体（serial）状態更新。
- 例外日（店舗/部屋/機材/スタッフ）登録 UI。
- スタッフ管理（表示/技能/稼働）最小。

受け入れ基準

- admin のみ編集可、member 参照可。

---

## フェーズ 8 リアルタイム/通知

- WS 購読: `reservations.updated/availability.updated/messages.new`。
- 楽観更新: ACK/rollback の UI 一貫動作。
- 通知: v1 はアプリ内トースト。

受け入れ基準

- 複数端末で編集反映が確認できる。

---

## フェーズ 9 エラー規約/監査の徹底

- 共通エラー形: `code/message/details` を統一。
- 監査ログ: 重要操作の記録・閲覧（admin）。

受け入れ基準

- 代表失敗ケースで一貫したエラー表示が行える。

---

## フェーズ 10 テスト/QA

- ユニット/統合: 予約作成・在庫・例外の経路を網羅。
- E2E: 予約作成フローを UI から通しで検証。
- 負荷/境界: 在庫逼迫や同時送信など高負荷シナリオを確認。

受け入れ基準

- 主要シナリオが安定し、CI のテストがすべて緑。

---

## フェーズ 11 非機能対応

- パフォーマンス: 初期バンドル ≤200KB、LCP/INP 目標。
- アクセシビリティ: キーボード操作完結、aria/コントラスト。
- 型/検証: API/WS を TypeScript+Zod で厳格化。
- セキュリティ: CSP/Rate limit/ログ最小実装。

受け入れ基準

- Core Web Vitals 目標に概ね到達。

---

## フェーズ 12 デプロイ/運用

- ステージング: 環境変数/DB スキーマ同期、移行手順をリハーサル。
- 本番: ログ/監視（メトリクス/アラート）設定、ロールアウト計画。
- バックアップ/復旧: スナップショット取得と復旧手順の演習。

受け入れ基準

- ロールバック手順が即時に実行可能で、監視・通知が稼働している。

---

## フェーズ 13 ドキュメント

- ワイヤーフレーム: 各画面 1 枚で主要操作を表現。
- シーケンス図: 予約作成/リスケ（UI↔API↔DB）を 1 枚追加。
- README/Runbook/トラブルシュートを整備。

受け入れ基準

- 新規メンバーが 1 日で開発参加可能。

---
