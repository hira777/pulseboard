# 要件定義書 (Requirements)

参照ドキュメント

- [機能一覧](./overview/features.md)
- [ユースケース一覧 & 図](./overview/use-cases.md)
- [画面遷移概要](./overview/screen-flow.md)
- [データモデル / スキーマ定義](./db/schema.md)

本プロダクトの中核機能。撮影スタジオの「部屋」と「機材（個体管理あり）」を同時に扱う実務運用を想定する。

## 1. 目的・スコープ

本プロダクトの中核機能は、撮影スタジオの「部屋」と「機材（個体管理あり）」を同時に扱う予約管理ダッシュボードです。

- 対象: 複数スタジオ（部屋）と機材レンタルを伴う撮影予約
- 粒度: 1 予約 = 1 つの「部屋」必須 ＋ 任意の「機材（複数可）」＋ 任意の「スタッフ」
- 時間刻み: 既定 15 分（将来 5/10/30 分へ切替可能）
- タイムゾーン: 店舗 TZ 固定（例: Asia/Tokyo）

スコープ外: 決済処理・会計処理・顧客課金などは含まない。

## 2. 用語集

- **予約**
  本システムの中心となる単位。必ず 1 つの部屋を含み、必要に応じて機材やスタッフを追加できる。
  例: 「Studio A を 10:00〜12:00 で予約し、Camera A を 1 台追加、スタッフ John をアサインする」

- **ステータス**:
  予約の状態を表す。

  - `confirmed`（確定）
  - `in_use`（利用中）
  - `completed`（完了）
  - `canceled`（キャンセル）
  - `no_show`（無断不使用）

- **SKU（Stock Keeping Unit）**:
  機材の種類を表す管理単位。UI では必要数量を入力するが、DB 上は後述の個体割当で確定する。
  例: "Camera A" という SKU に対して「2 台」を希望し、利用可能な個体を 2 つ確定する。

- **個体**:
  SKU の実物。シリアル番号や状態（`available`, `repair`, `lost` など）を持つ。
  予約確定時に `reservation_equipment_items` で個体 ID をひも付け、EXCLUDE 制約で二重予約を防ぐ。

- **キット**:
  複数の SKU をまとめたセット。セット単位で予約できるほか、必要に応じて単品を追加できる。
  例: 「照明セット（ライト 2 台＋スタンド 2 本）」＋「単品カメラ 1 台」

- **バッファ**:
  予約の前後に自動的に追加される時間。

  - `buffer_before_min` / `buffer_after_min`
  - 占有判定に含めて計算される

- **可用枠**:
  営業時間・例外日・競合（部屋/機材/スタッフの重複）を考慮して算出される予約可能時間枠。

- **テナント**:
  店舗や事業単位を表す論理的な区切り。URL `/t/:slug` で識別され、ユーザーは所属するテナント内のデータにのみアクセスできる。
  例: 「新宿スタジオ」「渋谷スタジオ」が別テナントとして存在し、ユーザーは所属するスタジオの予約や機材だけを閲覧できる。

## 3. ロールと権限

各ユーザーには **テナントごとに 1 つのロール** が割り当てられる。そのため、同じユーザーでも、テナントごとに異なるロールを持つことができる。ロールによってアクセス可能な画面や操作範囲が異なる。

- **admin**: 全データの閲覧/編集が可能。設定（営業時間・例外日・料金・機材・権限）の変更も行える。
- **member**: 自部署や担当範囲の予約を閲覧・作成・更新できる。ただし設定変更は不可。

### 3.1 認証・権限エラー時の挙動

- **ページ（App Router）**

  - 未認証: `/login` へリダイレクト
  - 未認可: 404 を返して存在を秘匿（画面上は「ページが見つかりません」と表示）

- **API / Actions**
  - 401: 未認証（ログインしていない → ログイン画面へ誘導）
  - 403: 認証済みだが権限不足（エラーメッセージ表示）
  - 404: 存在しない / 他テナント / 秘匿扱い（UI 上は「見つかりません」と表示）

### 3.2 ロール別アクセス権限一覧

| 画面/操作          | admin | member | 未認証 |
| ------------------ | :---: | :----: | :----: |
| ダッシュボード表示 |  ✅   |   ✅   |   ❌   |
| 予約一覧           |  ✅   |   ✅   |   ❌   |
| 予約作成/編集/取消 |  ✅   |   ✅   |   ❌   |
| 機材在庫（閲覧）   |  ✅   |   ✅   |   ❌   |
| 機材在庫（変更）   |  ✅   |   ❌   |   ❌   |
| スタッフ割当       |  ✅   |   ✅   |   ❌   |
| テナント設定変更   |  ✅   |   ❌   |   ❌   |

## 4. テナント識別方式

- URL: 各テナントを識別するルーティング方式として `/t/:slug` を採用する。
- Cookie: `tenant_id` で既定テナントを補完（URL にテナント指定がない直アクセスや初回アクセス時に、Cookie を参照して「どのテナントでログインしているか」を決定する）。
- RLS: DB は所属のデータのみ参照可能。他テナントの行は不可視。

## 5. 業務ルール

### 5.1 予約ライフサイクル

- 状態: `confirmed → in_use → completed` ／ `no_show` ／ `canceled`
- バッファ: サービス既定（前後 15 分など）を自動付与。予約単位で上書き可能（admin のみ）
- キャンセル規定: 開始 24 時間前まで無料、それ以降は 50%（v1 は表示のみ）

### 5.2 営業時間と例外日

- 営業時間: 曜日ごとに店舗/部屋単位で保持
- 例外日: 店舗/部屋/機材/スタッフ単位で設定可能
- 判定は「予約が占有する全リソース」に対して適用

### 5.3 機材の管理方式

- すべての SKU で個体管理を有効化できる（`track_serial=true` の場合は個体登録が必須）。
- 予約確定時: 必要数量ぶんの個体 ID をその場で確定し、`reservation_equipment_items` に保存。
- 二重予約防止: 個体×時間帯で EXCLUDE 制約を持ち、`confirmed`/`in_use` 状態と重なると DB が拒否。
- 故障/点検/紛失は個体ステータス変更で在庫から除外。既存予約には影響しないが要アラート表示。
- キット: セット定義は SKU 単位で行い、最終的には個体へ展開して割り当てる（S2 拡張を想定）。

### 5.4 競合/可用枠ロジック

- 占有範囲: 予約が実際に占有する時間は、利用開始・終了時刻に前後のバッファを加えた範囲で判定する。例: 開始 10:00、終了 12:00、バッファ 15 分 → 占有範囲は 09:45〜12:15。
- 判定順: 予約可能かどうかを判定するときは、以下の順でチェックする。
  - 1. 営業時間: そもそも店舗や部屋が開いているか
  - 2. 例外日: 定休日・メンテナンス・スタッフ休暇などで利用不可か
  - 3. 部屋: 同じ時間に部屋が既に予約されていないか
  - 4. 機材: 利用可能な個体が必要数ぶん確保できるか（重複は DB が排他）
  - 5. スタッフ: 必要なスタッフが空いているか
- 可用枠検索: 可用枠検索結果は件数が多くなるとレスポンスが重くなるため、返却件数は最大 50 件程度に制限することを推奨する（n ≤ 50）。

## 6. ユースケース

### UC-1: 予約を作成する

- **前提条件**: ユーザーはログイン済みで、対象テナントに所属している。
- **正常系**:
  1. ユーザーがサービスを選択
  2. 日時・部屋・機材・スタッフを指定
  3. 確定操作を行うと、競合・例外日チェックが実施される
  4. 問題がなければ `confirmed` 状態で保存
- **例外系**:
  - 可用枠が存在しない → 候補なしを返す
  - 競合検知 → エラー（409）

### UC-2: 予約を変更／リスケする

- **前提条件**: ユーザーは対象予約の編集権限を持つ。
- **正常系**:
  1. 既存予約の日時やリソースを変更
  2. 競合・例外日を再判定
  3. 問題なければ更新 → `confirmed` 状態に保存
- **例外系**:
  - 新条件で競合 → 更新拒否（409）
  - スタッフ・機材の在庫不足 → エラー表示
  - 他ユーザー更新済み → 楽観ロックエラー

### UC-3: 予約をキャンセルする

- **前提条件**: ユーザーは対象予約の編集権限を持つ。
- **正常系**:
  1. 予約詳細からキャンセル操作
  2. 状態が `canceled` に更新
  3. UI にキャンセル規定（24 時間前まで無料 / 以降 50%）を表示（v1 は表示のみ）
- **例外系**:
  - 他ユーザーによる更新競合 → エラー（409）

### UC-4: 担当スタッフを割り当てる

- **前提条件**: ユーザーは対象予約の編集権限を持つ。
- **正常系**:
  1. スタッフを検索・選択
  2. システムがスタッフの例外日・重複をチェック
  3. 問題がなければ予約に割り当て
- **例外系**:
  - スタッフが他予約で既に割当済み → エラー
  - 権限不足 → 403

### UC-5: 可用枠を検索する

- **前提条件**: ユーザーはログイン済みで対象テナントに所属。
- **正常系**:
  1. 期間・サービス・部屋・機材・スタッフ条件を入力
  2. サーバが条件をもとに可用枠を算出
  3. 最大 50 件まで候補を返却
- **例外系**:
  - 候補が存在しない → 「空きなし」表示
  - 条件エラー（期間が逆転など） → 422

### UC-6: カレンダー表示（週／日）

- **前提条件**: ユーザーはログイン済み。
- **正常系**:
  1. ユーザーがカレンダー画面を開く
  2. サーバから予約データを取得し、週／日単位で表示
  3. 部屋ごとに行を並べ、予約をドラッグ＆ドロップで移動・リサイズ可能
- **例外系**:
  - 権限不足の予約 → 非表示（RLS）
  - 更新競合 → UI 側で再読込を促す

### UC-7: 予約一覧を閲覧する

- **前提条件**: ユーザーはログイン済み。
- **正常系**:
  1. 一覧画面を開く
  2. サーバでフィルタ／ソートして結果を返す
  3. ユーザーは状態・部屋・サービス・顧客などで絞り込み可能
- **例外系**:
  - 権限不足の予約 → 非表示（RLS）

### UC-8: 予約詳細を確認・記録する

- **前提条件**: ユーザーは対象予約の閲覧権限を持つ。
- **正常系**:
  1. 予約詳細画面を開く
  2. 内部メモやスレッドチャットを記録
  3. 監査ログを参照可能
- **例外系**:
  - 権限不足 → 404（秘匿）

### UC-9: 顧客を管理する

- **前提条件**: ユーザーはログイン済み。
- **正常系**:
  1. 顧客一覧を閲覧
  2. 新規顧客を登録／既存顧客を更新／削除
- **例外系**:
  - 他ユーザー更新競合 → エラー（409）
  - 権限不足 → 403

### UC-10: 機材（SKU）を管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. 機材一覧を表示
  2. 新規 SKU 登録／既存 SKU 更新／有効・無効切替
  3. キット定義を作成・更新
- **例外系**:
  - 在庫数が既存予約と矛盾 → 更新拒否
  - 権限不足 → 403

### UC-11: 個体 (Equipment Item) を管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. 機材詳細から個体一覧を閲覧
  2. 個体の状態（available / repair / lost）を更新
- **例外系**:
  - 個体が予約に割当中 → 更新不可
  - 権限不足 → 403

### UC-12: 部屋を管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. 部屋一覧を表示
  2. 新規部屋を登録／既存部屋を更新
  3. 営業時間や表示色・収容人数を設定
- **例外系**:
  - 部屋に予約が存在する状態で削除 → 拒否
  - 権限不足 → 403

### UC-13: サービスを管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. サービス一覧を表示
  2. 新規サービスを登録／既存サービスを更新
  3. 所要時間・バッファ・表示色を設定
- **例外系**:
  - サービスが予約に紐付いている状態で削除 → 拒否
  - 権限不足 → 403

### UC-14: 例外日を管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. 例外日一覧を表示
  2. 店舗／部屋／機材／スタッフ単位で例外日を追加・削除
- **例外系**:
  - 他の例外日と重複 → バリデーションエラー
  - 権限不足 → 403

### UC-15: スタッフを管理する

- **前提条件**: ユーザーは admin ロール。
- **正常系**:
  1. スタッフ一覧を表示
  2. 新規スタッフを登録／既存スタッフを更新
- **例外系**:
  - スタッフが予約に紐付いている状態で削除 → 拒否
  - 権限不足 → 403

### UC-16: リアルタイム更新を受け取る

- **前提条件**: ユーザーは対象テナントにログイン済み。
- **正常系**:
  1. 他端末で予約が編集される
  2. サーバがリアルタイムイベントを送信
  3. クライアントは楽観ロックで更新を反映
- **例外系**:
  - 楽観ロック衝突 → 差分を表示して再試行を促す

## 7. 画面一覧

### 7.1 ダッシュボード

- **パス**: `/t/:slug/`
- **目的**: 今日/週の KPI と最近の更新を俯瞰。
- **権限**: admin, member
- **操作**:
  - 期間切替（今日 / 今週）
  - KPI カードの閲覧
  - 最近の更新の確認
  - ショートカット（予約作成 / カレンダー / 一覧）起動

### 7.2 カレンダー（週/日）

- **パス**: `/t/:slug/calendar/week`, `/t/:slug/calendar/day`
- **目的**: 部屋単位で予約を可視化し、ドラッグ操作で作成・リスケ。
- **権限**: admin, member
- **操作**:
  - 週/日表示切替
  - 部屋/サービス/状態でフィルタリング
  - 予約を D&D で移動・リサイズ
  - 予約詳細ドロワーを開く
  - Deep link: `/t/:slug/calendar/week?reservationId=:id` で特定予約にフォーカス

### 7.3 可用枠検索

- **パス**: `/t/:slug/availability`
- **目的**: 条件から候補スロットを検索し、予約作成へ遷移。
- **権限**: admin, member
- **操作**:
  - 期間 / サービス / 部屋 / 機材 / スタッフ条件を入力
  - 検索実行 → 候補スロットを一覧表示
  - 候補から予約作成画面へ遷移

### 7.4 予約一覧

- **パス**: `/t/:slug/reservations`
- **目的**: 予約の検索・運用。
- **権限**: admin, member
- **操作**:
  - サーバサイドフィルタ/ソート（クエリ: `status`, `roomId`, `serviceId`, `customer`, `from`, `to`）
  - 予約詳細への遷移
  - （将来）CSV エクスポート

### 7.5 予約作成（ウィザード/モーダル）

- **パス**: `/t/:slug/reservations/new`
- **目的**: サービス → 日時 → 部屋 → 機材 → 顧客 → 確認の段階的作成。
- **権限**: admin, member
- **操作**:
  - 各ステップで条件入力
  - 確定時に最終競合チェック
  - 問題なければ `confirmed` 状態で保存

### 7.6 予約詳細（ドロワー/直リンク）

- **パス**: `/t/:slug/reservations/:id`
- **目的**: 状態遷移、内部メモ、監査、機材割当。
- **権限**: admin, member
- **操作**:
  - 予約の状態遷移（`confirmed` → `in_use` → `completed` / `canceled`）
  - 内部ノートの追加・編集
  - メッセージ投稿（スレッドチャット）
  - 機材割当・解除
  - 監査ログの参照

### 7.7 顧客管理

- **パス**: `/t/:slug/customers`, `/t/:slug/customers/:id`
- **目的**: 顧客情報の CRUD。
- **権限**: admin, member
- **操作**:
  - 顧客一覧を表示
  - 新規顧客の登録
  - 既存顧客の更新
  - 顧客詳細の参照
  - （将来）削除

### 7.8 機材（SKU）管理

- **パス**: `/t/:slug/equipments`, `/t/:slug/equipments/:id`
- **目的**: 機材の在庫やキット定義、SKU 有効/無効の管理。
- **権限**: admin
- **操作**:
  - 機材一覧を表示
  - 新規 SKU の登録
  - 既存 SKU の更新（名称・在庫数・有効/無効）
  - キット定義の作成・更新

### 7.9 個体（Equipment Item）管理

- **パス**: `/t/:slug/equipments/:id/items`, `/t/:slug/equipment-items/:itemId`
- **目的**: 機材の個体を管理し、状態を更新。
- **権限**: admin
- **操作**:
  - 個体一覧を表示
  - 個体の状態更新（`available`, `repair`, `lost`）
  - 個体詳細の参照

### 7.10 部屋管理

- **パス**: `/t/:slug/rooms`
- **目的**: 部屋の営業時間・表示色・収容人数を管理。
- **権限**: admin
- **操作**:
  - 部屋一覧を表示
  - 新規部屋を登録
  - 既存部屋を更新（営業時間・色・収容人数）
  - （予約が存在しない場合のみ）削除

### 7.11 サービス管理

- **パス**: `/t/:slug/services`
- **目的**: サービスの所要時間・バッファ・色を管理。
- **権限**: admin
- **操作**:
  - サービス一覧を表示
  - 新規サービスを登録
  - 既存サービスを更新（時間・バッファ・色）
  - （予約が存在しない場合のみ）削除

### 7.12 例外日管理

- **パス**: `/t/:slug/exceptions`
- **目的**: 店舗/部屋/機材/スタッフの休業・メンテ等を登録。
- **権限**: admin
- **操作**:
  - 例外日一覧を表示
  - 新規例外日の登録
  - 既存例外日の削除
  - 重複チェック

### 7.13 スタッフ管理

- **パス**: `/t/:slug/staff`, `/t/:slug/staff/:id`
- **目的**: スタッフのスキルや稼働/私用例外を管理。
- **権限**: admin
- **操作**:
  - スタッフ一覧を表示
  - 新規スタッフを登録
  - 既存スタッフの更新（プロフィール・スキル・稼働）
  - （予約が存在しない場合のみ）削除

### 7.14 監査ログ

- **パス**: `/t/:slug/audit-logs`
- **目的**: 重要操作の履歴参照。
- **権限**: admin
- **操作**:
  - ログの一覧を表示
  - 期間 / ユーザー / 操作種別でフィルタリング
  - 詳細ログの参照

### 7.15 設定/管理トップ

- **パス**: `/t/:slug/admin`
- **目的**: 料金設定・権限・テナント設定を集約管理。
- **権限**: admin
- **操作**:
  - 料金表示設定の変更
  - 権限付与・変更
  - テナント情報の更新
  - 各管理画面へのナビゲーション

## 8. API のエラー規約

- **401 Unauthorized**

  - 状況: 未認証（ログインしていない）
  - 挙動: ログイン画面 `/login` へリダイレクト

- **403 Forbidden**

  - 状況: 認証済みだが権限不足
  - 挙動: 権限エラー表示（例: 「アクセス権限がありません」）

- **404 Not Found**

  - 状況: リソースが存在しない / 他テナントのデータを秘匿する場合
  - 挙動: 画面上は「存在しないリソース」として扱う

- **409 Conflict**

  - 状況: 楽観ロックエラー / 機材・スタッフの在庫競合
  - 挙動: 再読込や再試行を促す
  - 実装: `If-Match` ヘッダと `version` カラムで制御

- **422 Unprocessable Entity**

  - 状況: 入力検証エラー（例: 必須項目未入力、期間が逆転している）
  - 挙動: フォームにバリデーションエラーを表示

- **429 Too Many Requests**

  - 状況: レート制限（短時間での過剰アクセス）
  - 挙動: エラーメッセージを表示し、リトライ可能になるまで待機

> ※ 今後、Server Action との共通化や RFC 7807 準拠の詳細仕様を追記予定。

## 9. 非機能要件

本システムの非機能要件は以下のとおりとする。**Must** は初期リリース時点で必ず満たすもの、**Should** は運用開始までに整備するものを示す。

### 9.1 パフォーマンス

- **予約作成 API**: P95 < 500ms（95% のリクエストが 500ms 未満で応答）
- **可用枠検索 API**: 最大 n=50 件を返却対象、P95 < 800ms を目標
- **一覧表示**: サーバサイドページングにより 1,000 件規模でも快適操作
- **フロントエンド**:
  - 初期バンドル ≤ 200KB gzip
  - Core Web Vitals を達成（LCP < 2.5s, CLS < 0.1, INP < 200ms）
  - カレンダー/一覧画面は 60fps を目標

**Must**

### 9.2 可用性・信頼性

- 稼働率 99.9% を目標
- **RTO** ≤ 1h、**RPO** ≤ 15min
- DB バックアップ: 日次フル + PITR（ポイントインタイムリカバリ）、四半期ごとに復元演習
- マルチ AZ 運用を前提とする

**Must**

### 9.3 セキュリティ

- **RLS**: 所属テナント以外は不可視
- **RBAC**: admin/member に基づく権限制御
- **CSRF 対策**: セッション + トークン
- **HTTPS**: 通信経路暗号化必須
- **PII 最小化**: 個人情報は必要最小限、保存時は暗号化
- **CSP**: 適切な Content Security Policy を適用
- **Rate limit**: API ごとに設定（未認証は IP+UA、認証済は userId 単位）
- **IP/UA ログ収集**: 不正検知・監査用
- **権限昇格**: admin 権限付与は承認フロー必須
- **秘密管理**: 環境変数は Secret Manager / KMS を利用、鍵ローテーション

**Must**

### 9.4 リアルタイム更新

- 予約・在庫の変更は他端末にリアルタイム反映
- 通知は **ACK（受信確認）＋リプレイ** を前提
- 更新は **楽観ロック方式**、衝突時は差分提示＋再試行を促す
- 冪等性を担保（Idempotency-Key / version 管理）

**Must**

### 9.5 運用・監査

- **監査ログ**: 予約確定/変更/キャンセル/在庫状態変更/権限変更はすべて `audit_logs` に記録
- **相関 ID**: 全リクエストに `correlationId` を付与し、ログ・監査・分散トレーシングで突合可能とする
- **監視**: API レイテンシ、エラー率、DB 負荷をメトリクス化
- **アラート**: SLO 逸脱、エラー率急増、バックグラウンドジョブ滞留を検知

**Must**

### 9.6 アクセシビリティ

- WCAG 2.1 AA 相当を目標
- キーボード操作のみで主要フローを完結可能
- 適切な `aria` 属性を付与
- コントラスト比は最低 4.5:1 を遵守
- 自動テスト（axe-core 等）で主要フローをチェック

**Must**

### 9.7 型安全・契約

- API / WebSocket の Payload は **TypeScript 型 + Zod** でバリデーション
- API 契約の変更は型定義を通じてコンパイル時に検知できるようにする

**Must**

### 9.8 テスト・品質

- **ユニットテスト**: ドメインロジックをカバー
- **E2E テスト**: 予約作成/編集/キャンセルなど主要フローを自動化（Playwright 等）
- **契約テスト**: API とフロント間の互換性検証
- **性能試験**: 予約作成・可用枠検索でピーク負荷を想定したテストを実施

**Must**

### 9.9 拡張性・スケーラビリティ

- マルチテナント前提で設計し、負荷に応じてスケール可能とする
- 将来的な要件（5/10/30 分刻みの予約単位、顧客向け予約アプリ拡張）を許容できるデータモデル

**Should**

### 9.10 非機能要件チェックリスト

<!-- prettier-ignore-start -->
| カテゴリ | 要件 | 基準値 / 目標 | 確認方法 |
|----------|------|---------------|-----------|
| パフォーマンス(API) | 予約作成 API | P95 < 500ms | 負荷試験・APM |
| パフォーマンス(API) | 可用枠検索 API | n ≤ 50 件、P95 < 800ms | 負荷試験・APM |
| パフォーマンス(一覧) | 予約一覧表示 | 1,000 件でも快適操作 | 手動/自動テスト |
| パフォーマンス(フロント) | 初期バンドル | ≤ 200KB gzip | CI バンドルサイズ計測 |
| パフォーマンス(UX) | Core Web Vitals | LCP < 2.5s, CLS < 0.1, INP < 200ms | RUM / Lighthouse |
| パフォーマンス(UI) | カレンダー/一覧 | 60fps 目標 | DevTools Performance |
| 可用性 | 稼働率 | 99.9% 以上 | 監視ツール / SLA |
| 可用性 | RTO / RPO | RTO ≤ 1h, RPO ≤ 15min | DR 演習 |
| 可用性 | バックアップ | 日次 + PITR | 復元演習 |
| セキュリティ | RLS | 所属テナント以外不可視 | RLS テスト |
| セキュリティ | RBAC | admin/member 制御 | 権限テスト |
| セキュリティ | HTTPS | 通信経路暗号化 | インフラ設定確認 |
| セキュリティ | CSRF 対策 | トークン必須 | ペネトレーションテスト |
| セキュリティ | PII 最小化 | 最小限のみ保存、暗号化 | DB スキーマレビュー |
| セキュリティ | CSP | 適切に設定 | ヘッダ確認 / ZAP |
| セキュリティ | Rate limit | API ごとに設定 | 負荷試験 / Middleware |
| セキュリティ | IP/UA ログ | 記録される | ログ確認 |
| セキュリティ | 権限昇格 | 承認フロー必須 | 運用フロー確認 |
| セキュリティ | 秘密管理 | Secret Manager / KMS 利用 | IaC / インフラ設定確認 |
| リアルタイム | 更新反映 | 他端末に即時同期 | 実機テスト |
| リアルタイム | ACK/rollback | 通知失敗時に rollback | E2E テスト |
| リアルタイム | 冪等性 | Idempotency-Key / version 管理 | API テスト |
| 運用 | 監査ログ | 確定/変更/取消/在庫/権限を記録 | audit_logs 確認 |
| 運用 | 相関 ID | 全リクエストに付与 | ログトレーシング確認 |
| 運用 | 監視 | レイテンシ/エラー率可視化 | Grafana/Prometheus |
| 運用 | アラート | SLO 逸脱を検知 | Alertmanager |
| アクセシビリティ | キーボード操作 | 主要フローを完結可能 | E2E + Axe-core |
| アクセシビリティ | aria 属性 | 適切に付与 | コードレビュー |
| アクセシビリティ | コントラスト比 | 4.5:1 以上 | Axe / Lighthouse |
| 型安全 | API/WS Payload | TypeScript 型 + Zod バリデーション | 型定義 + テスト |
| テスト | ユニットテスト | ドメインロジックを網羅 | Jest/Coverage |
| テスト | E2E テスト | 予約作成/編集/取消フロー自動化 | Playwright |
| テスト | 契約テスト | API とフロント互換性担保 | Pact/Contract Test |
| テスト | 性能試験 | 主要 API のピーク負荷試験 | k6 / JMeter |
| 拡張性 | スケーラビリティ | マルチテナント前提 | アーキレビュー |
| 拡張性 | 将来拡張性 | 時間刻み変更/顧客アプリ拡張に対応 | データモデルレビュー |
<!-- prettier-ignore-end -->

## 10. 規定値

本システムにおける主要な既定値（デフォルト値）は以下の通り。
テナント設定やサービス設定で上書き可能なものは「変更可否」を明示する。

<!-- prettier-ignore-start -->
| 項目 | 既定値 | 根拠 / 補足 | 変更可否 |
|------|--------|-------------|----------|
| 時間刻み | 15 分 | 多くの予約業務での一般的単位。将来は 5/10/30 分対応予定 | ○（テナント設定） |
| バッファ | 前後 15 分 | 準備/片付け時間を考慮 | ○（サービス単位で変更可） |
| キャンセル規定 | 24 時間前まで無料 | スタジオ標準規約を想定 | ○（テナント設定） |
| 予約状態の初期値 | `confirmed` | 作成時に確定 | × |
| サービス所要時間 | 60 分 | `Standard` サービスの例を既定とする | ○（サービス設定） |
| サービス色 | `#2e7` | 初期登録サービスの例示 | ○（サービス設定） |
| カレンダー表示初期値 | 週表示 | 予約の俯瞰を優先 | ○（ユーザー設定） |
| タイムゾーン | Asia/Tokyo | 店舗単位で固定 | △（環境ごとに固定） |
| 日付フォーマット | `YYYY-MM-DD` | API / DB の統一形式 | × |
| バージョン初期値 | 1 | 楽観ロック用 | × |
| Rate Limit（仮） | 認証済: 60 req/min<br>未認証: 10 req/min | 運用負荷を想定した初期値 | ○（システム設定） |
| 監査ログ保持期間 | 1 年 | コンプライアンス対応 | ○（環境設定） |
| アクセスログ保持期間 | 6 ヶ月 | 運用トレーサビリティ | ○（環境設定） |
| 相関 ID 形式 | UUID v4 | シンプルで衝突回避可能 | × |
<!-- prettier-ignore-end -->

## 11. 受け入れ基準とトレーサビリティ（v1）

> v1 の受け入れ条件を、仕様（features.md / use-cases.md）および E2E テストと対応付ける。

- 予約を **作成**できる（競合/例外日チェックを含む）

  - 出典: use-cases.md#uc-1-予約を作成する / features.md#予約作成
  - E2E テスト: e2e/reservation-create.spec.ts

- 予約を **変更/リスケ**できる（競合再判定あり）

  - 出典: use-cases.md#uc-2-予約を変更リスケする / features.md#予約編集
  - E2E テスト: e2e/reservation-reschedule.spec.ts

- 予約を **キャンセル**できる（状態が canceled に遷移）

  - 出典: use-cases.md#uc-3-予約をキャンセルする / features.md#予約キャンセル
  - E2E テスト: e2e/reservation-cancel.spec.ts

- 予約に **担当スタッフを割当/解除**できる

  - 出典: use-cases.md#uc-4-担当スタッフを割り当てる / features.md#スタッフ割当
  - E2E テスト: e2e/staff-assign.spec.ts

- **可用枠検索** が条件（期間/サービス/部屋/機材/スタッフ）で動作する（上限 50）

  - 出典: use-cases.md#uc-5-可用枠を検索する / features.md#可用枠検索
  - E2E テスト: e2e/availability-search.spec.ts

- **カレンダー（週/日）** で予約が表示され、D&D で作成・移動・リサイズできる

  - 出典: use-cases.md#uc-6-カレンダー表示週日 / features.md#カレンダー
  - E2E テスト: e2e/calendar-dnd.spec.ts

- **予約一覧** でフィルタ/ソートでき、詳細へ遷移できる

  - 出典: use-cases.md#uc-7-予約一覧を閲覧する / features.md#予約一覧
  - E2E テスト: e2e/reservation-list.spec.ts

- **予約詳細** でノート/スレッド/監査ログが参照・投稿できる

  - 出典: use-cases.md#uc-8-予約詳細を確認記録する / features.md#予約詳細
  - E2E テスト: e2e/reservation-detail.spec.ts

- **顧客管理**（作成/更新/閲覧）ができる

  - 出典: use-cases.md#uc-9-顧客を管理する / features.md#顧客管理
  - E2E テスト: e2e/customers-crud.spec.ts

- **機材（SKU）管理**（作成/更新/有効無効/キット定義）ができる

  - 出典: use-cases.md#uc-10-機材 sku を管理する / features.md#機材管理
  - E2E テスト: e2e/equipments-crud.spec.ts

- **個体（シリアル）管理**（状態更新 available/repair/lost）ができる

  - 出典: use-cases.md#uc-11-個体-equipment-item-を管理する / features.md#個体管理
  - E2E テスト: e2e/equipment-items-update.spec.ts

- **部屋管理**（作成/更新、営業時間設定）ができる

  - 出典: use-cases.md#uc-12-部屋を管理する / features.md#部屋管理
  - E2E テスト: e2e/rooms-crud.spec.ts

- **サービス管理**（所要時間/バッファ/色の設定）ができる

  - 出典: use-cases.md#uc-13-サービスを管理する / features.md#サービス管理
  - E2E テスト: e2e/services-crud.spec.ts

- **例外日管理**（店舗/部屋/機材/スタッフ単位の登録/削除）ができる

  - 出典: use-cases.md#uc-14-例外日を管理する / features.md#例外日管理
  - E2E テスト: e2e/exceptions-crud.spec.ts

- **スタッフ管理**（作成/更新、稼働/私用例外）ができる

  - 出典: use-cases.md#uc-15-スタッフを管理する / features.md#スタッフ管理
  - E2E テスト: e2e/staff-crud.spec.ts

- **リアルタイム反映**：他端末編集が数秒以内に同期される（楽観ロックで衝突処理）

  - 出典: use-cases.md#uc-16-リアルタイム更新を受け取る / features.md#リアルタイム
  - E2E テスト: e2e/realtime-sync.spec.ts

- **ロール/権限**：admin と member の権限マトリクス通りにアクセス可否が機能する

  - 出典: requirements.md#3-ロールと権限 / features.md#権限制御
  - E2E テスト: e2e/authorization-matrix.spec.ts

- **テナント識別方式**：URL/Cookie/RLS によるデータ分離が機能する（他テナント不可視）

  - 出典: requirements.md#テナント識別方式 / features.md#テナント
  - E2E テスト: e2e/tenant-isolation.spec.ts

- **API エラー規約** に準拠したエラー（401/403/404/409/422/429）の UI ハンドリングができる

  - 出典: requirements.md#6-api のエラー規約
  - E2E テスト: e2e/error-handling.spec.ts

- **非機能（性能）**：Core Web Vitals/LCP/INP、バンドル ≤ 200KB を満たす

  - 出典: requirements.md#7-非機能要件
  - E2E テスト: e2e/perf-webvitals.spec.ts

- **非機能（セキュリティ）**：RLS/RBAC/CSRF/CSP/Rate limit/監査ログが動作する
  - 出典: requirements.md#7-非機能要件
  - E2E テスト: e2e/security-basics.spec.ts

## 12. 未確定（確認したい事項）

### v1 で必須に決定すべき事項

- **テナントの招待/ロール管理フロー**

  - なぜ必要か: マルチテナント SaaS では「誰がどのテナントに所属するか」をどう制御するかがセキュリティ・運用効率に直結する。
  - 選択肢:
    1. 招待メール必須（安全だが手間が増える）
    2. 自己参加許可（UX 向上だが不正リスク増）
    3. ロール変更に承認フローを設ける

- **認証/サインイン方式**

  - なぜ必要か: 管理系サービスにおいて「メールリンクのみで十分か」「パスワード併用が必要か」でリスク許容度が変わる。
  - 選択肢:
    1. Magic Link のみ
    2. パスワードのみ
    3. Magic Link + パスワード併用

- **セッション有効期限**

  - なぜ必要か: 短いと UX が悪化、長いと不正利用リスクが増す。適切な TTL を決めないと運用トラブルの原因になる。
  - 選択肢:
    1. 短期（例: 1 日）
    2. 中期（例: 7 日）
    3. 長期（例: 30 日、要リフレッシュトークン）

- **キャンセルポリシー**

  - なぜ必要か: 収益と顧客体験に直結。曖昧だとユーザーの混乱や損害に繋がる。
  - 選択肢:
    1. 24 時間前まで無料、それ以降は全額
    2. 段階的キャンセル料（24h 前=50%、当日=100% など）
    3. 無断キャンセル時はペナルティ付与

- **予約詳細 URL とドロワーの整合**

  - なぜ必要か: 直リンクと deep link が混在すると UX が複雑化する。統一方針が必要。
  - 選択肢:
    1. `/reservations/:id` を正とし、ドロワーからもリンク可能にする
    2. `/calendar?reservationId=...` を許容し、直リンクはリダイレクトする

- **可用枠検索のページング/上限**

  - なぜ必要か: 上限未定だと負荷試験や UX 設計ができない。
  - 選択肢:
    1. 上限 n=50 固定
    2. 上限 n=50 + ページングサポート
    3. 上限 n=100（高性能 DB 前提）

- **重複検知の丸め規則/バッファ適用順序**

  - なぜ必要か: 未定義だと「同じ入力でも予約できる/できない」が発生しバグの温床になる。
  - 選択肢:
    1. 刻み未満入力は切り上げ
    2. 刻み未満入力は切り捨て
    3. バッファを開始時点で適用 or 終了時点で適用

- **顧客データの重複判定キー**

  - なぜ必要か: 重複登録があると業務効率や分析精度が落ちる。判定基準を統一しないとデータクレンジングが困難。
  - 選択肢:
    1. email 優先
    2. 電話番号優先
    3. email + 電話の複合キー
    4. 名前 + 補助情報

- **機材破損/修理フロー**

  - なぜ必要か: 機材が「修理中 → 利用可」に戻るトリガーを決めないと在庫が不正確になる。
  - 選択肢:
    1. 修理完了後に自動復帰
    2. 管理者承認で手動復帰
    3. 状態変更を監査ログに残す

- **監査/アクセスログの保持期間**

  - なぜ必要か: 法的要件やセキュリティ監査で必要。決めないとストレージコスト増やコンプライアンス違反につながる。
  - 選択肢:
    1. 6 ヶ月
    2. 1 年
    3. 3 年（業界基準が厳しい場合）

- **API レスポンスの最大リスト件数**

  - なぜ必要か: 過大レスポンスは DoS リスクや UX 劣化を招く。上限を定めないと負荷試験の基準も作れない。
  - 選択肢:
    1. 100 件
    2. 200 件
    3. サーバ設定で動的に調整可能にする

- **メンテナンス告知方法**
  - なぜ必要か: 告知がないと顧客満足度を大きく下げる。方法が曖昧だと現場で混乱する。
  - 選択肢:
    1. UI バナーのみ
    2. UI バナー + メール通知
    3. 専用「ステータスページ」を用意

### v1.1 以降で整備してもよい事項

（例示、すべてに「なぜ必要か」「選択肢」を追加）

- **多要素認証**

  - なぜ必要か: セキュリティ強度を高められるが UX とコストを圧迫する。
  - 選択肢: SMS / TOTP / 外部 IdP 連携

- **アカウント凍結/退会ポリシー**

  - なぜ必要か: GDPR/個人情報保護法に関わる。削除しすぎても監査できず、残しすぎても法的リスク。
  - 選択肢: 即時削除 / 一定期間保持 / 匿名化保持

- **遅刻・無断キャンセル時のペナルティ**

  - なぜ必要か: 利用者行動を律し、リソース浪費を防ぐ。
  - 選択肢: 警告 / 課金 / 一定期間予約停止

- **同一顧客/スタッフ/機材の同時予約上限**
  - なぜ必要か: 不正利用やシステム負荷を防ぐ。
  - 選択肢: 上限なし / 1 件 / N 件（可変）

### 将来検討（v2 以降でも可）

- **多言語対応**

  - なぜ必要か: グローバル展開を可能にする。
  - 選択肢: i18n ライブラリ利用 / テナント単位設定 / ユーザー単位設定

- **外部カレンダー連携**

  - なぜ必要か: ユーザーの既存業務フローに統合しやすくなる。
  - 選択肢: Google Calendar API / Outlook API / 双方向 or 片方向同期

- **外部決済サービス**
  - なぜ必要か: 自動課金やオンライン決済を実現。
  - 選択肢: Stripe / PayPal / 国内決済サービス
